{% comment %}
Questo file sovrascrive il template del widget per:
1. Caricare l'HTML e il CSS originali.
2. Caricare il file JS originale (che definisce la classe 'IconPicker').
3. Eseguire uno script che SOVRASCRIVE i metodi difettosi della classe
   prima di inizializzarla.
{% endcomment %}

{% load static %}

<link rel="stylesheet" href="{% static 'django_icon_picker/css/icon_picker.css' %}">
<div class="icon-picker-container">
  <div class="icon-picker-wrapper">
    <div class="icon-picker-input" style="display: flex; align-items: center;">
      <img class="icon-preview" id="selectedIcon" class="" style="margin-right: 10px;">
      <input type="{{ widget.type }}" name="{{ widget.name }}" class="vTextField" model_name="{{ widget.attrs.model_name }}"
             {% if widget.value != None %} value="{{ widget.value|stringformat:'s' }}"{% endif %}
             {% include "django/forms/widgets/attrs.html" %}>

      <input class="vTextField" id="color" value="{{ widget.attrs.color|default:'#00bcc9' }}" type="text" data-coloris style="margin-left: 10px;">
    </div>
    <div id="results"></div>
  </div>
</div>

<script src="{% static 'django_icon_picker/js/icon_picker.js' %}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    
    // --- INIZIO PATCH JS v4 ---

    // 1. Correggi la funzione di download (parametri separati)
    IconPicker.prototype.downloadAndSaveSvg = function(iconName, iconColor) {
        // BUGFIX: Passa 'icon' e 'color' come parametri separati
        const downloadUrl = `/icon_picker/download-svg/?icon=${iconName}&color=${iconColor}&id=${this.objectId}&model=${this.model}`;
        
        return fetch(downloadUrl) // Restituisce la promise
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`Errore server: ${response.status} ${response.statusText}`);
                }
                return response.text();
            })
            .then((data) => {
                // 'data' è il percorso del file salvato (es. 'media/punteggio/icon-....svg')
                this.searchInput.value = data; 
                return data; 
            });
    };

    // 2. Correggi la funzione 'click' (non scrive il percorso prematuramente)
    IconPicker.prototype.createDropdownItem = function(icon, iconUrl) {
        const item = document.createElement("div");
        item.className = "icon-dropdown-item";
        const iconImg = document.createElement("img");
        iconImg.src = iconUrl;
        iconImg.className = "icon-preview";
        const iconText = document.createElement("span");
        iconText.textContent = icon;
        iconText.className = "icon-name";
        item.appendChild(iconImg);
        item.appendChild(iconText);
        
        const pickerInstance = this; 
        item.addEventListener("click", () => {
            // BUGFIX: Imposta solo il nome dell'icona (es. "mdi:star")
            pickerInstance.searchInput.value = icon; 
            pickerInstance.selectedIcon.src = iconUrl;
            pickerInstance.resultsDiv.innerHTML = "";
            pickerInstance.icon = icon; // Imposta l'icona che verrà salvata
        });
        return item;
    };

    // 3. Corregge la funzione 'setupEventListeners' per il 'submit' (async/await)
    IconPicker.prototype.setupEventListeners = function() {
        // (Listener 'input' originale - OK)
        this.searchInput.addEventListener("input", () => {
            const query = this.searchInput.value;
            if (query.length > 2) {
                this.searchIcons(query);
            } else {
                this.resultsDiv.innerHTML = "";
            }
        });

        // (Listener 'submit' PATCHATO)
        this.form.addEventListener("submit", async (event) => {
            // Se 'media' è impostato E una *nuova* icona è stata scelta
            if (this.savePath && this.icon) { 
                
                event.preventDefault(); // Blocca l'invio del form
                
                try {
                    var color = this.colorPicker.value.replace("#", "%23");
                    
                    // Chiama la nostra funzione di download patchata e ASPETTA
                    await this.downloadAndSaveSvg(this.icon, color);
                    
                    // Ora che this.searchInput.value è stato aggiornato
                    // dalla funzione di download, invia il form.
                    this.form.submit();
                } catch (error) {
                    console.error("IconPicker Patch: Fallimento salvataggio icona, submit annullato.", error);
                    this.form.submit(); // Fallback per non bloccare l'utente
                }
            }
        });
    };
    
    // 4. Ora inizializza l'istanza, che userà le nostre funzioni patchate
    new IconPicker({
      searchInputId: "id_{{ widget.name }}",
      savePath: "{{ widget.attrs.save_path }}",
      model: "{{ widget.attrs.model_name }}",
      objectId: "{{ widget.attrs.object_id }}",
    });
    
    // --- FINE PATCH JS v4 ---
  });
</script>